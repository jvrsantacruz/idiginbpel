<?xml version="1.0" encoding="UTF-8"?><!--
   BPEL Process Definition
   Edited using ActiveBPEL(tm) Designer Version 3.0.0 (http://www.active-endpoints.com)
  --><process xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:bpws="http://schemas.xmlsoap.org/ws/2003/03/business-process/" xmlns:tns="http://docs.active-endpoints.com/activebpel/sample/wsdl/marketplace/2006/09/marketplace.wsdl" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:uca="http://www.uca.es/xpath/2007/11" name="marketplace" targetNamespace="http://docs.active-endpoints.com/activebpel/sample/wsdl/marketplace/2006/09/marketplace.wsdl" uca:dummy="dummy"><bpel:extensions xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"><bpel:extension mustUnderstand="no" namespace="http://www.uca.es/xpath/2007/11"/></bpel:extensions>

  <import importType="http://schemas.xmlsoap.org/wsdl/" location="dependencias/marketplace.wsdl" namespace="http://docs.active-endpoints.com/activebpel/sample/wsdl/marketplace/2006/09/marketplace.wsdl"/>
  <partnerLinks>
    <partnerLink myRole="sales" name="seller" partnerLinkType="tns:salesplnk"/>
    <partnerLink myRole="buying" name="buyer" partnerLinkType="tns:buyingplnk"/>
  </partnerLinks>
  <bpel:variables xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"><variable messageType="tns:sellerInfoMessage" name="sellerInfo"/><variable name="dummy_sellerInfo" uca:instrument="no" messageType="tns:sellerInfoMessage"/><variable messageType="tns:negotiationMessage" name="negotiationOutcome"/><variable name="dummy_negotiationOutcome" uca:instrument="no" messageType="tns:negotiationMessage"/><variable messageType="tns:buyerInfoMessage" name="buyerInfo"/><variable name="dummy_buyerInfo" uca:instrument="no" messageType="tns:buyerInfoMessage"/></bpel:variables>

  <correlationSets>
    <correlationSet name="negotiationIdentifier" properties="tns:negotiatedItem"/>
  </correlationSets>

  <faultHandlers>
    <catch faultName="bpel:joinFailure"><bpel:sequence xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"><!--inicio de inspecciones para /process[1]/faultHandlers[1]/catch[1]:::ENTER--><bpel:assign uca:punto="ENTER"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/faultHandlers[1]/catch[1]:::ENTER-->
      <compensate/>
    <!--inicio de inspecciones para /process[1]/faultHandlers[1]/catch[1]:::EXIT--><bpel:assign uca:punto="EXIT"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/faultHandlers[1]/catch[1]:::EXIT--></bpel:sequence></catch>
    <catchAll>
      <!-- Do not compensate implicitly: we want the mutant without
           a joinCondition to behave differently -->
      <empty/>
    </catchAll>
  </faultHandlers>

  <flow name="MarketplaceFlow">
    <links>
      <link name="firstSeller1"/>
      <link name="firstBuyer1"/>
      <link name="firstSeller2"/>
      <link name="firstBuyer2"/>
      <link name="secondSeller"/>
      <link name="secondBuyer"/>
      <link name="ifToSellerReply"/>
      <link name="ifToBuyerReply"/>
    </links>

    <!-- First message, either from the buyer or the seller -->
    <pick createInstance="yes" name="FirstMessage">
      <onMessage operation="submit" partnerLink="seller" portType="tns:sellerPT" variable="sellerInfo">
        <correlations>
          <correlation initiate="join" set="negotiationIdentifier"/>
        </correlations>
        <scope name="FirstMessageFromSeller">
          <compensationHandler>
            <sequence><!--inicio de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[1]/scope[1]/compensationHandler[1]/sequence[1]:::ENTER--><bpel:assign xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/" uca:punto="ENTER"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[1]/scope[1]/compensationHandler[1]/sequence[1]:::ENTER-->
              <assign name="CancelledAssignSeller">
                <copy>
                  <from>uca:ambito(0, '@0@Deal Cancelled@0@')</from>
                  <to part="outcome" variable="negotiationOutcome"/>
                </copy>
              </assign>
              <reply name="NotifySellerOfCancelledDeal" operation="submit" partnerLink="seller" portType="tns:sellerPT" variable="negotiationOutcome"/>
            <!--inicio de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[1]/scope[1]/compensationHandler[1]/sequence[1]:::EXIT--><bpel:assign xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/" uca:punto="EXIT"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[1]/scope[1]/compensationHandler[1]/sequence[1]:::EXIT--></sequence>
          </compensationHandler>
          <empty>
            <sources>
              <source linkName="firstSeller1"/>
              <source linkName="firstSeller2"/>
            </sources>
          </empty>
        </scope>
      </onMessage>
      <onMessage operation="submit" partnerLink="buyer" portType="tns:buyerPT" variable="buyerInfo">
        <correlations>
          <correlation initiate="join" set="negotiationIdentifier"/>
        </correlations>
        <scope name="FirstMessageFromBuyer">
          <compensationHandler>
            <sequence><!--inicio de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[2]/scope[1]/compensationHandler[1]/sequence[1]:::ENTER--><bpel:assign xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/" uca:punto="ENTER"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[2]/scope[1]/compensationHandler[1]/sequence[1]:::ENTER-->
              <assign name="CancelledAssignBuyer">
                <copy>
                  <from>uca:ambito(0, '@0@Deal Cancelled@0@')</from>
                  <to part="outcome" variable="negotiationOutcome"/>
                </copy>
              </assign>
              <reply name="NotifyBuyerOfCancelledDeal" operation="submit" partnerLink="buyer" portType="tns:buyerPT" variable="negotiationOutcome"/>
            <!--inicio de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[2]/scope[1]/compensationHandler[1]/sequence[1]:::EXIT--><bpel:assign xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/" uca:punto="EXIT"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/flow[1]/pick[1]/onMessage[2]/scope[1]/compensationHandler[1]/sequence[1]:::EXIT--></sequence>
          </compensationHandler>
          <empty>
            <sources>
              <source linkName="firstBuyer1"/>
              <source linkName="firstBuyer2"/>
            </sources>
          </empty>
        </scope>
      </onMessage>
    </pick>

    <!-- The other party has 5 seconds to send a message -->
    <pick name="SecondMessage">
      <targets>
        <target linkName="firstBuyer1"/>
        <target linkName="firstSeller1"/>
      </targets>

      <onMessage operation="submit" partnerLink="seller" portType="tns:sellerPT" variable="sellerInfo">
        <correlations>
          <correlation initiate="join" set="negotiationIdentifier"/>
        </correlations>
        <empty>
          <sources>
            <source linkName="secondSeller"/>
          </sources>
        </empty>
      </onMessage>
      <onMessage operation="submit" partnerLink="buyer" portType="tns:buyerPT" variable="buyerInfo">
        <correlations>
          <correlation initiate="join" set="negotiationIdentifier"/>
        </correlations>
        <empty>
          <sources>
            <source linkName="secondBuyer"/>
          </sources>
        </empty>
      </onMessage>
      <onAlarm>
        <for>'P0DT0H5S'</for>
        <empty/>
      </onAlarm>
    </pick>

    <!-- Negotiate -->
    <if name="MarketplaceSwitch"><targets>
        <target linkName="firstSeller2"/>
        <target linkName="firstBuyer2"/>
        <target linkName="secondSeller"/>
        <target linkName="secondBuyer"/>
        <joinCondition>
          ($firstSeller2 and $secondBuyer) or ($firstBuyer2 and $secondSeller)
        </joinCondition>
      </targets><sources>
        <source linkName="ifToSellerReply"/>
        <source linkName="ifToBuyerReply"/>
      </sources><condition>uca:ambito(0, '(uca:imprimirRutas(1, @0@$sellerInfo.askingPrice@0@) &lt;= uca:imprimirRutas(1, @0@$buyerInfo.offer@0@))')</condition><bpel:sequence xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"><!--inicio de inspecciones para //*[@name='MarketplaceSwitch']:::ENTER--><bpel:assign uca:punto="ENTER"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para //*[@name='MarketplaceSwitch']:::ENTER--><assign name="SuccessAssign">
        <copy>
          <from>uca:ambito(0, '@0@Deal Successful@0@')</from>
          <to part="outcome" variable="negotiationOutcome"/>
        </copy>
      </assign><!--inicio de inspecciones para //*[@name='MarketplaceSwitch']:::EXIT--><bpel:assign uca:punto="EXIT"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para //*[@name='MarketplaceSwitch']:::EXIT--></bpel:sequence><else><bpel:sequence xmlns:vprop="http://docs.oasis-open.org/wsbpel/2.0/varprop" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"><!--inicio de inspecciones para /process[1]/flow[1]/if[1]/else[1]:::ENTER--><bpel:assign uca:punto="ENTER"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/flow[1]/if[1]/else[1]:::ENTER--><assign name="FailedAssign">
          <copy>
            <from>uca:ambito(0, '@0@Deal Failed@0@')</from>
            <to part="outcome" variable="negotiationOutcome"/>
          </copy>
        </assign><!--inicio de inspecciones para /process[1]/flow[1]/if[1]/else[1]:::EXIT--><bpel:assign uca:punto="EXIT"><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.inventoryItem')</bpel:from><bpel:to>$dummy_sellerInfo.inventoryItem</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$sellerInfo.askingPrice')</bpel:from><bpel:to>$dummy_sellerInfo.askingPrice</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$negotiationOutcome.outcome')</bpel:from><bpel:to>$dummy_negotiationOutcome.outcome</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.item')</bpel:from><bpel:to>$dummy_buyerInfo.item</bpel:to></bpel:copy><bpel:copy ignoreMissingFromData="yes"><bpel:from>uca:inspeccionar(0, '$buyerInfo.offer')</bpel:from><bpel:to>$dummy_buyerInfo.offer</bpel:to></bpel:copy></bpel:assign><!--fin de inspecciones para /process[1]/flow[1]/if[1]/else[1]:::EXIT--></bpel:sequence></else></if>

    <!-- Report results -->
    <reply name="SellerReply" operation="submit" partnerLink="seller" portType="tns:sellerPT" suppressJoinFailure="yes" variable="negotiationOutcome">
      <targets>
        <target linkName="ifToSellerReply"/>
      </targets>
    </reply>
    <reply name="BuyerReply" operation="submit" partnerLink="buyer" portType="tns:buyerPT" suppressJoinFailure="yes" variable="negotiationOutcome">
      <targets>
        <target linkName="ifToBuyerReply"/>
      </targets>
    </reply>

  </flow>
</process>